name: Deploy to Deployment Repository

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:
    inputs:
      target_repo:
        description: 'Target deployment repository (format: owner/repo)'
        required: false
        default: ''
      target_branch:
        description: 'Target branch in deployment repository'
        required: false
        default: 'main'

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout source repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for proper sync
          
      - name: Configure Git
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions@github.com'
      
      - name: Setup deployment repository information
        id: setup
        run: |
          # Use workflow input if provided, otherwise use environment variable
          if [ -n "${{ github.event.inputs.target_repo }}" ]; then
            echo "target_repo=${{ github.event.inputs.target_repo }}" >> $GITHUB_OUTPUT
            echo "target_branch=${{ github.event.inputs.target_branch }}" >> $GITHUB_OUTPUT
          elif [ -n "${{ vars.DEPLOYMENT_REPO }}" ]; then
            # Use repository variable if configured
            echo "target_repo=${{ vars.DEPLOYMENT_REPO }}" >> $GITHUB_OUTPUT
            echo "target_branch=${{ vars.DEPLOYMENT_BRANCH || 'deploy' }}" >> $GITHUB_OUTPUT
          else
            # No deployment target configured
            echo "Error: No deployment target configured."
            echo "Please set either:"
            echo "  1. DEPLOYMENT_REPO repository variable, or"
            echo "  2. Run workflow manually with target_repo input"
            exit 1
          fi
          
      - name: Display deployment information
        run: |
          echo "Deploying to repository: ${{ steps.setup.outputs.target_repo }}"
          echo "Target branch: ${{ steps.setup.outputs.target_branch }}"
          echo "Source commit: ${{ github.sha }}"
          
      - name: Push to deployment repository
        env:
          DEPLOY_TOKEN: ${{ secrets.DEPLOY_TOKEN }}
          TARGET_REPO: ${{ steps.setup.outputs.target_repo }}
          TARGET_BRANCH: ${{ steps.setup.outputs.target_branch }}
        run: |
          set -e  # Exit on error
          
          if [ -z "$DEPLOY_TOKEN" ]; then
            echo "Warning: DEPLOY_TOKEN secret is not set. Skipping deployment."
            echo "Please set the DEPLOY_TOKEN secret in repository settings to enable deployment."
            exit 0
          fi
          
          # Function to clean up credentials
          cleanup() {
            rm -f ~/.git-credentials
            git config --global --unset credential.helper || true
          }
          
          # Set trap to ensure cleanup happens even on error
          trap cleanup EXIT
          
          # Configure git credential helper to avoid exposing token in URLs
          git config --global credential.helper store
          echo "https://x-access-token:${DEPLOY_TOKEN}@github.com" > ~/.git-credentials
          
          # Set up the deployment remote using HTTPS without token in URL
          git remote add deployment https://github.com/${TARGET_REPO}.git
          
          # Fetch the deployment repository with better error handling
          echo "Fetching deployment repository..."
          if git fetch deployment 2>&1; then
            echo "âœ“ Successfully fetched from deployment repository"
            FETCH_SUCCESS=true
          else
            echo "Note: Could not fetch from deployment repository."
            echo "This may be normal if it's a new repository or the branch doesn't exist yet."
            FETCH_SUCCESS=false
          fi
          
          # Push to the deployment repository
          echo "Pushing to ${TARGET_REPO}@${TARGET_BRANCH}..."
          if [ "$FETCH_SUCCESS" = true ]; then
            # Use --force-with-lease for safety when we successfully fetched
            # This prevents overwriting if remote has been updated since fetch
            git push deployment HEAD:${TARGET_BRANCH} --force-with-lease=refs/heads/${TARGET_BRANCH}
          else
            # For new repositories or branches, use regular push
            # This is safe because there's nothing to overwrite
            git push deployment HEAD:${TARGET_BRANCH}
          fi
          
          echo "Successfully deployed to ${TARGET_REPO}@${TARGET_BRANCH}"
